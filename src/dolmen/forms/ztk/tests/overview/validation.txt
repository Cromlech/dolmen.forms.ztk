================
dolmen.forms.ztk
================

Interfaces can be validated, if they contain invariants. Invariants
are explicit contacts defining constraints on the data.


Single invariant
================

Definition
----------

  >>> from zope.schema import Password
  >>> from zope.interface import invariant, Interface
  >>> from zope.interface.exceptions import Invalid

  >>> class IPasswords(Interface):
  ...     passwd = Password(
  ...         title=u"Password",
  ...         description=u"Type the password.",
  ...         required=True)
  ...
  ...     verify = Password(
  ...         title=u"Password checking",
  ...         description=u"Retype the password.",
  ...         required=True)
  ...
  ...     @invariant
  ...     def check_pass(data):
  ...         if data.passwd != data.verify:
  ...             raise Invalid(u"Mismatching passwords!")


Instanciation
-------------

  >>> from dolmen.forms.base import Fields, FormData
  >>> from cromlech.browser.testing import TestHTTPRequest
  >>> form = FormData(object(), TestHTTPRequest())
  >>> fields = Fields(IPasswords)

  >>> from dolmen.forms.ztk import InvariantsValidation
  >>> validator = InvariantsValidation(fields, form)

  >>> print validator
  <dolmen.forms.ztk.validation.InvariantsValidation object at ...>

  >>> print validator.interfaces
  [<InterfaceClass __builtin__.IPasswords>]


Providing some data
-------------------

  >>> from dolmen.forms.base.components import FieldsValues

  >>> data = FieldsValues(form, fields)
  >>> data.update({'passwd': 'test', 'verify': 'nopass'})
  >>> print validator.validate(data)
  [Invalid(u'Mismatching passwords!',)]

  >>> data = FieldsValues(form, fields)
  >>> data.update({'passwd': 'test', 'verify': 'test'})
  >>> print validator.validate(data)
  []


Multiple invariants
===================

Definition
----------

  >>> from zope.schema import Int, Choice

  >>> class IAgeAndLegals(Interface):
  ...    age = Int(
  ...        title=u"Enter your age.",
  ...        required=True)
  ...        
  ...    accept = Choice(
  ...        title=u"I accept the conditions of use.",
  ...        required=True,
  ...        values=[u"I accept", u"I disapprove"])
  ...
  ...    @invariant
  ...    def check_age(data):
  ...        if data.age < 18:
  ...            raise Invalid(u"You must be at least 18 to proceed.")
  ...
  ...    @invariant
  ...    def check_legals(data):
  ...        if data.accept != u"I accept":
  ...            raise Invalid(u"You can not proceed if you disagree.")


Instanciation
-------------

  >>> form = FormData(object(), TestHTTPRequest())
  >>> fields = Fields(IAgeAndLegals)
  >>> validator = InvariantsValidation(fields, form)

  >>> print validator
  <dolmen.forms.ztk.validation.InvariantsValidation object at ...>

  >>> print validator.interfaces
  [<InterfaceClass __builtin__.IAgeAndLegals>]


Providing some data
-------------------

  >>> data = FieldsValues(form, fields)
  >>> data.update({'age': 17, 'accept': u"I disapprove"})
  >>> print validator.validate(data)
  [Invalid(u'You must be at least 18 to proceed.',),
   Invalid(u'You can not proceed if you disagree.',)]

  >>> data = FieldsValues(form, fields)
  >>> data.update({'age': 17, 'accept': u"I accept"})
  >>> print validator.validate(data)
  [Invalid(u'You must be at least 18 to proceed.',)]

  >>> data = FieldsValues(form, fields)
  >>> data.update({'age': 19, 'accept': u"I accept"})
  >>> print validator.validate(data)
  []


Invariant involving values not in form
======================================

If some attributes used by invariant computation are not in the form the values
will be ask to datamanager::

  >>> class IAdult(Interface):
  ...    age = Int(
  ...        title=u"Enter your age.",
  ...        required=True)
  ...        
  ...    country = Choice(
  ...        title=u"Country",
  ...        required=True,
  ...        values=[u'Korea', u'France'])
  ...
  ...    @invariant
  ...    def check_age(data):
  ...        
  ...        if data.age < {u'Korea': 17, u'France':18}[data.country]:
  ...            raise Invalid(u"You must be major to proceed.")



Instanciation
-------------

We will have two form permitting to edit already existing object, but
just the age::

  >>> class Person(object):
  ... 
  ...     def __init__(self, country, age):
  ...         self.country, self.age = country, age

  >>> edit_french = FormData(Person(u'France', None), TestHTTPRequest())
  >>> edit_korean = FormData(Person(u'Korea', None), TestHTTPRequest())
  >>> fields = Fields(IAdult).omit('country')


Providing some data
-------------------

Let's edit the french and check

  >>> data = FieldsValues(edit_french, fields)
  >>> data.update({'age': 17})
  >>> print InvariantsValidation(fields, edit_french).validate(data)
  [Invalid(u'You must be major to proceed.',)]

  >>> data.update({'age': 18})
  >>> print InvariantsValidation(fields, edit_french).validate(data)
  []

  >>> data = FieldsValues(edit_korean, fields)
  >>> data.update({'age': 17})
  >>> print InvariantsValidation(fields, edit_korean).validate(data)
  []


Form integration
================

Integration environment
-----------------------

  >>> from grokcore.component import context, Context
  >>> from dolmen.forms.base import Form, Fields

  >>> class SomeContent(Context):
  ...     pass

  >>> from cromlech.browser.testing import TestHTTPResponse

  >>> class MyLegalPage(Form):
  ...     context(SomeContent)
  ...
  ...     responseFactory = TestHTTPResponse
  ...     fields = Fields(IAgeAndLegals)
  ...     dataValidators = [InvariantsValidation]
  ...     ignoreRequest = False
  ...     ignoreContent = True

  >>> content = SomeContent()


Erroneous submissions
---------------------

Let's try an empty request. There is two invariants, so that generate
two errors for the form itself:

  >>> request = TestHTTPRequest(form={'age': 10})
  >>> form = MyLegalPage(content, request)
  >>> form.update()

  >>> data, errors = form.extractData()
  >>> data
  {'age': <Marker NO_VALUE>, 'accept': <Marker NO_VALUE>}
  >>> list(errors)
  [<Error Missing required value.>,
   <Error Missing required value.>,
   <Errors for 'form'>]

  >>> list(errors['form'])
  [<Error You must be at least 18 to proceed.>,
   <Error You can not proceed if you disagree.>]

  >>> list(form.formErrors)
  [<Error You must be at least 18 to proceed.>,
   <Error You can not proceed if you disagree.>]
